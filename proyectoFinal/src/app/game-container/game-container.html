<div class="game-wrapper">
  <div class="menu-overlay" *ngIf="showMenu()">
    <div class="menu-container">
      <button class="btn-close-menu" (click)="goBackToPreviousPage()" title="Volver">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
          <path d="M15 18l-6-6 6-6"/>
        </svg>
      </button>
      <div class="menu-header">
        <h1>DashWare</h1>
      </div>
      <section class="menu-section">
        <div class="section-header">
          <div>
            <h2>Configuración de Partida</h2>
            <p>Selecciona el mapa y crea tu partida</p>
          </div>
        </div>
        <div class="map-selector-main" *ngIf="localMapsService.localMaps().length > 0">
          <label for="map-select-main">Mapa a jugar:</label>
          <select id="map-select-main" [(ngModel)]="selectedMapId" class="map-select">
            <option value="">Mapa por defecto</option>
            <option *ngFor="let map of localMapsService.localMaps()" [value]="map.id">
              {{ map.name }} - por {{ map.author }}
            </option>
          </select>
          <p class="map-hint" *ngIf="selectedMapId">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
              <circle cx="12" cy="12" r="10"></circle>
              <path d="M12 16v-4M12 8h.01" stroke="#cccccc" stroke-width="2"></path>
            </svg>
            Mapa personalizado seleccionado
          </p>
        </div>
        <button 
          (click)="startHost()" 
          class="btn btn-host btn-full"
          [disabled]="isGeneratingCode() || hostId()"
        >
          <span class="spinner" *ngIf="isGeneratingCode()"></span>
          <span>{{ isGeneratingCode() ? 'Generando código...' : (hostId() ? 'Partida creada' : 'Crear Partida') }}</span>
        </button>
        <div *ngIf="isGeneratingCode()" class="loading-box">
          <div class="loading-animation">
            <div class="loading-dots">
              <span></span>
              <span></span>
              <span></span>
            </div>
            <p>Generando código único...</p>
          </div>
        </div>
        <div *ngIf="hostId() && !isGeneratingCode()" class="code-display-box">
          <div class="code-label">
            <span>Código de la partida</span>
          </div>
          <div class="code-value">
            <span class="code-char" *ngFor="let char of hostId().split('')">{{ char }}</span>
          </div>
          <p class="code-hint">Comparte este código con otros jugadores</p>
        </div>
        <div *ngIf="role() === 'host' && !connected() && hostId()" class="waiting-box">
          <div class="waiting-animation">
            <div class="pulse-ring"></div>
          </div>
          <p class="waiting-text">Esperando jugadores...</p>
        </div>
        <div *ngIf="role() === 'host' && connected()" class="start-game-box">
          <p class="connected-msg">¡Jugador conectado!</p>
          <p class="map-selected-info" *ngIf="selectedMapId">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polygon points="1 6 1 22 8 18 16 22 23 18 23 2 16 6 8 2 1 6"></polygon>
            </svg>
            Jugarán en: {{ getSelectedMapName() }}
          </p>
          <button (click)="startGameAsHost()" class="btn btn-start">
            Iniciar Juego
          </button>
        </div>
      </section>
      <div class="divider"></div>
      <section class="menu-section">
        <div class="section-header">
          <div>
            <h2>Unirse a Partida</h2>
            <p>Ingresa el código de 5 caracteres del host</p>
          </div>
        </div>
        <div class="input-group">
          <input 
            type="text" 
            class="input-code" 
            placeholder="Ej: A3K9M" 
            [(ngModel)]="connectId"
            maxlength="5"
            (input)="connectId = connectId.toUpperCase()"
            [disabled]="isConnecting()"
          />
          <button 
            (click)="startClient()" 
            class="btn btn-connect"
            [disabled]="isConnecting() || connectId.length !== 5"
          >
            <span class="spinner" *ngIf="isConnecting()"></span>
            <span>{{ isConnecting() ? 'Conectando...' : 'Conectar' }}</span>
          </button>
        </div>
        <div *ngIf="isConnecting()" class="connecting-box">
          <div class="connecting-animation">
            <div class="connecting-dots">
              <span></span>
              <span></span>
              <span></span>
            </div>
            <p>Conectando al host...</p>
          </div>
        </div>
        <div *ngIf="role() === 'client' && connected()" class="waiting-box">
          <div class="waiting-animation">
            <div class="pulse-ring"></div>
          </div>
          <p class="waiting-text">Conectado! Esperando que el host inicie el juego...</p>
          <p class="map-info-text" *ngIf="selectedMapId">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polygon points="1 6 1 22 8 18 16 22 23 18 23 2 16 6 8 2 1 6"></polygon>
            </svg>
            El host seleccionó un mapa personalizado
          </p>
        </div>
      </section>
    </div>
  </div>
  <header class="hud" *ngIf="!showMenu()">
    <div class="hud-left">
      <div class="badge" [class.badge-connected]="connected()" [class.badge-disconnected]="!connected()">
        <span class="status-dot"></span>
        <span class="badge-value">{{ connected() ? 'Conectado' : 'Desconectado' }}</span>
      </div>
    </div>
    <div class="hud-center">
      <div *ngIf="latency() !== undefined" class="latency-display">
        <span class="latency-value">{{ latency() }}ms</span>
      </div>
    </div>
    <div class="hud-right">
      <button (click)="backToMenu()" class="btn-back" title="Volver al menú">
        <span>Menú</span>
      </button>
    </div>
  </header>
  <div #gameContainer class="phaser-container" aria-label="Área del juego"></div>
  <div class="game-ui" *ngIf="!showMenu()">
    <div class="player-stats player-1">
      <div class="player-label">P1</div>
      <div class="stocks">
        <img 
          *ngFor="let stock of [1,2,3]" 
          src="sprites/player1_stock.png"
          [class.hidden]="stock > playerStocks()"
          class="stock-icon"
          alt="Stock"
        />
      </div>
      <div class="percent">{{ playerPercent() }}%</div>
    </div>
    <div class="player-stats player-2" *ngIf="connected()">
      <div class="player-label">P2</div>
      <div class="stocks">
        <img 
          *ngFor="let stock of [1,2,3]" 
          src="sprites/player2_stock.png"
          [class.hidden]="stock > remotePlayerStocks()"
          class="stock-icon"
          alt="Stock"
        />
      </div>
      <div class="percent">{{ remotePlayerPercent() }}%</div>
    </div>
  </div>
  <footer class="game-footer" *ngIf="!showMenu()">
    <div class="controls-info-game">
      <span class="footer-hint"><kbd>Z</kbd> Saltar</span>
      <span class="footer-hint"><kbd>X</kbd> Dash</span>
      <span class="footer-hint"><kbd>C</kbd> Atacar</span>
    </div>
  </footer>
</div>
